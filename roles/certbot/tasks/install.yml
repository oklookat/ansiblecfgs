---
- name: Install required packages
  ansible.builtin.apt:
    name:
      - cron
      - python3
      - python3-dev
      - python3-venv
      - python3-pip 
      - libaugeas-dev
      - gcc
    state: present
    update_cache: yes

- name: Enable and start cron
  ansible.builtin.systemd:
    name: cron
    enabled: true
    state: started

- name: Create virtual environment for certbot
  ansible.builtin.shell: python3 -m venv {{ certbot_path }}
  args:
    creates: "{{ certbot_path }}"

- include_tasks: upgrade_pip.yml

- name: Install certbot in virtual environment
  ansible.builtin.pip:
    name: certbot
    virtualenv: "{{ certbot_path }}"
    state: present

- name: Add certbot upgrade cron job
  ansible.builtin.cron:
    name: "certbot auto upgrade"
    minute: "0"
    hour: "0"
    day: "1"
    user: root
    job: "{{ certbot_pip_path }} install --upgrade certbot"
