---
- include_tasks: community_crypto.yml

- name: Ensure certificate directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: "{{ openssl_ssl_group_name }}"
    mode: "0750"
  loop:
    - "{{ openssl_key_path | dirname }}"
    - "{{ cert_openssl_certificate_path | dirname }}"

- name: Generate private key if not exists
  community.crypto.openssl_privatekey:
    path: "{{ openssl_key_path }}"
    size: 2048
    type: RSA
    mode: "0640"
    group: "{{ openssl_ssl_group_name }}"
  register: key_result
  changed_when: key_result.changed

- name: Check if CSR exists
  ansible.builtin.stat:
    path: "{{ temp_csr_path }}"
  register: csr_stat

- name: Generate CSR
  community.crypto.openssl_csr:
    path: "{{ temp_csr_path }}"
    privatekey_path: "{{ openssl_key_path }}"
    common_name: "{{ sni }}"
    subject_alt_name:
      - "DNS:{{ sni }}"
      - "DNS:www.{{ sni }}"
  when: key_result.changed or not csr_stat.stat.exists

- name: Generate self-signed certificate
  community.crypto.x509_certificate:
    path: "{{ cert_openssl_certificate_path }}"
    csr_path: "{{ temp_csr_path }}"
    privatekey_path: "{{ openssl_key_path }}"
    provider: selfsigned
    selfsigned_not_after: "+{{ openssl_cert_days }}d"
    selfsigned_not_before: "+0s"
    mode: "0644"
    group: "{{ openssl_ssl_group_name }}"
    force: false
  register: cert_result

- name: Cleanup temporary CSR
  ansible.builtin.file:
    path: "{{ temp_csr_path }}"
    state: absent
  when: cert_result is succeeded

- block:
    - name: Read certificate content
      ansible.builtin.slurp:
        src: "{{ cert_openssl_certificate_path }}"
      register: cert_pubkey_content

    - name: Read private key content
      ansible.builtin.slurp:
        src: "{{ openssl_key_path }}"
      register: cert_key_content

    - name: Convert certificate to JSON array
      ansible.builtin.set_fact:
        certificate_json: >-
          {{ (cert_pubkey_content.content | b64decode)
             .splitlines()
             | reject('equalto', '')
             | list }}

    - name: Convert private key to JSON array
      ansible.builtin.set_fact:
        certificate_key_json: >-
          {{ (cert_key_content.content | b64decode)
             .splitlines()
             | reject('equalto', '')
             | list }}

    - name: Save certificate JSON on localhost
      ansible.builtin.copy:
        dest: "./{{ inventory_hostname }}-{{ sni }}-cert.json"
        content: |
          {
            "certificate": {{ certificate_json | to_nice_json }}
          }
        mode: "0644"
      delegate_to: localhost
      run_once: true

    - name: Save private key JSON on localhost
      ansible.builtin.copy:
        dest: "./{{ inventory_hostname }}-{{ sni }}-cert-key.json"
        content: |
          {
            "private_key": {{ certificate_key_json | to_nice_json }}
          }
        mode: "0600"
      delegate_to: localhost
      run_once: true
  when: cert_result.changed
