---
- name: "ansiblecfgs: deploy-group"
  hosts: all
  become: true
  tasks:
    - name: Ensure the group exists
      ansible.builtin.group:
        name: "{{ group_name }}"
        state: present

    - name: Get existing group memberships for each user
      ansible.builtin.command: id -nG {{ item }}
      register: user_groups
      changed_when: false
      failed_when: false
      loop: "{{ group_users }}"

    - name: Add users to group only if not already a member
      ansible.builtin.user:
        name: "{{ item.item }}"
        groups: "{{ group_name }}"
        append: true
      when: group_name not in item.stdout.split()
      loop: "{{ user_groups.results }}"

    - name: Ensure all shared directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: "{{ group_name }}"
        mode: "2775" # rwxr-sr-x (setgid)
      loop: "{{ shared_dirs }}"

    - name: Ensure group ownership recursively
      ansible.builtin.file:
        path: "{{ item }}"
        group: "{{ group_name }}"
        recurse: true
      loop: "{{ shared_dirs }}"

    - name: Ensure group has read/write/execute permissions recursively
      ansible.builtin.file:
        path: "{{ item }}"
        mode: "g+rwX"
        recurse: true
      loop: "{{ shared_dirs }}"
