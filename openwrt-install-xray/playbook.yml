---
- import_playbook: "templates/playbook.yml"
- import_playbook: "compress/playbook.yml"
- name: "ansiblecfgs: openwrt-install-xray"
  hosts: all
  gather_facts: false
  tasks:
    - name: Update opkg
      raw: opkg update

    - name: Install openssh-sftp-server
      raw: opkg install openssh-sftp-server

    - name: Install kmod-nft-tproxy
      raw: opkg install kmod-nft-tproxy

    - name: Stop service (ignore errors)
      raw: service xray stop || true

    - name: Ensure required directories exist
      raw: |
        mkdir -p "{{ xray_bin | dirname }}"
        mkdir -p "{{ xray_location_config | dirname }}"
        mkdir -p "{{ xray_location_asset }}"
        {% if xray_location_confdir is defined and xray_location_confdir != '' %}
        mkdir -p "{{ xray_location_confdir }}"
        {% endif %}

    - name: Copy binary
      local_action: shell scp -P {{ ansible_port }} {{ compress_xray_bin }} 'root@{{ ansible_host }}:{{ xray_bin }}'

    - name: Make binary executable
      raw: chmod +x "{{ xray_bin }}"

    - name: Copy etc config
      local_action: shell scp -P {{ ansible_port }} {{ ts_xray_etc_config }} 'root@{{ ansible_host }}:{{ xray_etc_config }}'

    - name: Copy initd config
      local_action: shell scp -P {{ ansible_port }} {{ ts_xray_initd_config }} 'root@{{ ansible_host }}:{{ xray_initd_config }}'

    - name: Copy config
      local_action: shell scp -P {{ ansible_port }} {{ ts_xray_config }} 'root@{{ ansible_host }}:{{ xray_location_config }}'

    - name: Copy geosite
      local_action: shell scp -P {{ ansible_port }} {{ ts_xray_geosite }} 'root@{{ ansible_host }}:{{ xray_geosite }}'

    - name: Copy geoip
      local_action: shell scp -P {{ ansible_port }} {{ ts_xray_geoip }} 'root@{{ ansible_host }}:{{ xray_geoip }}'

    - name: Make initd config executable
      raw: chmod +x "{{ xray_initd_config }}"

    # - name: Start service (ignore errors)
    #   raw: service xray start || true
