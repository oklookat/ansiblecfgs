#!/bin/sh /etc/rc.common

USE_PROCD=1
START=99
PROG="{{ xray_bin }}"

start_service() {
  config_load "xray"

  local enabled config_file
  local log_stderr log_stdout
  config_get_bool enabled "main" "enabled" "0"
  [ "$enabled" -eq "1" ] || return 0

  config_get config_file "main" "conffile" "{{ xray_location_config }}"
  config_get_bool log_stderr "main" "log_stderr" "1"
  config_get_bool log_stdout "main" "log_stdout" "1"

  procd_open_instance
  procd_set_param command "$PROG" "-c" "$config_file"
  procd_set_param file "$config_file"
  procd_set_param stdout "$log_stdout"
  procd_set_param stderr "$log_stderr"
  procd_set_param limits core="unlimited"
  procd_set_param limits nofile="1000000 1000000"
  procd_set_param respawn

  procd_set_param env XRAY_LOCATION_CONFIG="$config_file"
  procd_set_param env XRAY_LOCATION_ASSET="{{ xray_location_asset }}"
  {% if xray_location_confdir is defined and xray_location_confdir != "" %}
  procd_set_param env XRAY_LOCATION_CONFDIR="{{ xray_location_confdir }}"
  {% endif %}
  
  procd_close_instance
}

service_triggers() {
  procd_add_reload_trigger "xray"
}