---
- name: "ansiblecfgs: install-xray"
  hosts: all
  become: true
  tasks:
    - name: Update package index
      apt:
        update_cache: yes

    - name: Create xray system user
      user:
        name: "{{ xray_username }}"
        system: true
        shell: /usr/sbin/nologin
        create_home: no
        state: present

    - name: Install Xray via Xray-install
      ansible.builtin.shell: |
        bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install -u '{{ xray_username }}'
      args:
        creates: /usr/local/bin/xray

    - name: Ensure config directory exists
      file:
        path: /usr/local/etc/xray
        state: directory
        owner: "{{ xray_username }}"
        group: "{{ xray_username }}"
        mode: "0750"

    - name: Ensure log directory exists
      file:
        path: /var/log/xray
        state: directory
        owner: "{{ xray_username }}"
        group: "{{ xray_username }}"
        mode: "0750"

    - name: Fix ownership of config files
      file:
        path: /usr/local/etc/xray
        owner: "{{ xray_username }}"
        group: "{{ xray_username }}"
        recurse: yes

    - name: Fix ownership of logs
      file:
        path: /var/log/xray
        owner: "{{ xray_username }}"
        group: "{{ xray_username }}"
        recurse: yes

    - name: Ensure systemd drop-in dir exists
      file:
        path: /etc/systemd/system/xray.service.d
        state: directory
        mode: "0755"

    - name: Install systemd override to run as xray and keep capability
      copy:
        dest: /etc/systemd/system/xray.service.d/override.conf
        content: |
          [Service]
          User={{ xray_username }}
          Group={{ xray_username }}
          AmbientCapabilities=CAP_NET_BIND_SERVICE
        owner: root
        group: root
        mode: "0644"
      notify:
        - systemd daemon-reload
        - restart xray

    - name: Create Xray update cron task (monthly)
      cron:
        name: "Monthly Xray auto-update"
        user: root
        special_time: monthly
        job: 'bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install -u {{ xray_username }} && systemctl daemon-reload && systemctl restart xray'

    - name: Enable and ensure xray is running
      systemd:
        name: xray
        enabled: true
        state: restarted

  handlers:
    - name: systemd daemon-reload
      ansible.builtin.command: systemctl daemon-reload

    - name: restart xray
      ansible.builtin.service:
        name: xray
        state: restarted
