---
- name: "ansiblecfgs: install-xray"
  hosts: all
  become: true
  tasks:
    - name: Update package index
      apt:
        update_cache: yes

    - name: Create xray system user
      user:
        name: xray
        system: true
        shell: /usr/sbin/nologin
        home: /var/lib/xray
        create_home: no
        state: present

    - name: Install Xray via Xray-install with User=xray
      ansible.builtin.shell: |
        bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install -u xray
      args:
        creates: /usr/local/bin/xray

    - name: Ensure config directory exists
      file:
        path: /usr/local/etc/xray
        state: directory
        owner: xray
        group: xray
        mode: "0750"

    - name: Ensure log directory exists
      file:
        path: /var/log/xray
        state: directory
        owner: xray
        group: xray
        mode: "0750"

    - name: Fix ownership of config files
      file:
        path: /usr/local/etc/xray
        owner: xray
        group: xray
        recurse: yes

    - name: Fix ownership of logs
      file:
        path: /var/log/xray
        owner: xray
        group: xray
        recurse: yes

    - name: Ensure systemd drop-in dir exists
      file:
        path: /etc/systemd/system/xray.service.d
        state: directory
        mode: "0755"

    - name: Install systemd override to run as xray and keep capability
      copy:
        dest: /etc/systemd/system/xray.service.d/override.conf
        content: |
          [Service]
          User=xray
          Group=xray
          AmbientCapabilities=CAP_NET_BIND_SERVICE
        owner: root
        group: root
        mode: "0644"
      notify: Reload and restart xray

    - name: Create Xray update cron task (monthly)
      cron:
        name: "Monthly Xray auto-update"
        user: root
        special_time: monthly
        job: 'bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install -u xray && systemctl daemon-reload && systemctl restart xray'

    - name: Enable and ensure xray is running
      systemd:
        name: xray
        enabled: true
        state: restarted

  handlers:
    - name: Reload and restart xray
      systemd:
        daemon_reload: yes
        name: xray
        state: restarted
