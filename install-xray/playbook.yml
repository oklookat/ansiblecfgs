---
- name: "ansiblecfgs: install-xray"
  hosts: all
  become: true
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Create xray system user
      user:
        name: "{{ xray_username }}"
        system: true
        shell: /usr/sbin/nologin
        create_home: no
        state: present

    - name: Install Xray
      shell: |
        bash -c "$(curl -fsSL https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install -u {{ xray_username }}
      args:
        creates: /usr/local/bin/xray

    - name: Ensure config directory exists
      file:
        path: /usr/local/etc/xray
        state: directory
        owner: "{{ xray_username }}"
        group: "{{ xray_username }}"
        mode: "0750"

    - name: Ensure log directory exists
      file:
        path: /var/log/xray
        state: directory
        owner: "{{ xray_username }}"
        group: "{{ xray_username }}"
        mode: "0750"

    - name: Ensure systemd override directory exists
      file:
        path: /etc/systemd/system/xray.service.d
        state: directory
        mode: "0755"

    - name: Install systemd override for xray
      copy:
        dest: /etc/systemd/system/xray.service.d/override.conf
        owner: root
        group: root
        mode: "0644"
        content: |
          [Service]
          User={{ xray_username }}
          Group={{ xray_username }}
          AmbientCapabilities=CAP_NET_BIND_SERVICE
      notify:
        - systemd daemon-reload
        - restart xray

    - name: Create xray-update helper script if autoupdate enabled
      copy:
        dest: /usr/local/bin/xray-update.sh
        owner: root
        group: root
        mode: "0755"
        content: |
          #!/bin/bash
          echo "[xray-update] starting update"
          bash -c "$(curl -fsSL https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install{% if xray_autoupdate_without_geodata %} --without-geodata{% endif %} -u {{ xray_username | quote }}
          systemctl daemon-reload
          systemctl restart xray
          echo "[xray-update] update finished"
      when: xray_autoupdate | default(false)

    - name: Install xray-update systemd service
      template:
        src: xray-update.service.j2
        dest: /etc/systemd/system/xray-update.service
        owner: root
        group: root
        mode: "0644"
      when: xray_autoupdate | default(false)
      notify: systemd daemon-reload

    - name: Install xray-update systemd timer
      template:
        src: xray-update.timer.j2
        dest: /etc/systemd/system/xray-update.timer
        owner: root
        group: root
        mode: "0644"
      when: xray_autoupdate | default(false)
      notify: systemd daemon-reload

    - name: Enable and start xray-update timer
      systemd:
        name: xray-update.timer
        enabled: true
        state: started
      when: xray_autoupdate | default(false)

    - name: Disable xray-update timer if autoupdate disabled
      systemd:
        name: xray-update.timer
        enabled: false
        state: stopped
      when: not xray_autoupdate | default(false)

    - name: Ensure Xray is enabled and running
      systemd:
        name: xray
        enabled: true
        state: started

  handlers:
    - name: systemd daemon-reload
      command: systemctl daemon-reload

    - name: restart xray
      service:
        name: xray
        state: restarted
