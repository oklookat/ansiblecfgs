---
- name: "ansiblecfgs: basic"
  vars:
    new_ssh_port: 65000
    new_user_name: ""
    new_user_password: ""
    new_root_password: ""
  hosts: all
  become: true
  tasks:
    - name: Update and upgrade the system
      apt:
        update_cache: yes
        upgrade: dist
      register: apt_result
      until: apt_result is succeeded
      retries: 10
      delay: 15

    - name: Update NetworkManager configuration
      block:
        - name: Ensure NetworkManager config directory exists
          file:
            path: /etc/NetworkManager
            state: directory

        - name: Patch NetworkManager.conf
          lineinfile:
            path: /etc/NetworkManager/NetworkManager.conf
            insertafter: '^#?\[main\]'
            create: yes
            line: "{{ item }}"
          loop:
            - "dns=none"
            - "rc-manager=unmanaged"
      when: ansible_facts.packages['network-manager'] is defined

    - name: Configure DNS server
      copy:
        content: "nameserver 1.1.1.1\n"
        dest: /etc/resolv.conf
        force: yes

    - name: Change root password
      user:
        name: root
        password: "{{ new_root_password | password_hash('sha512') }}"

    - name: Add a new user
      user:
        name: "{{ new_user_name }}"
        password: "{{ new_user_password | password_hash('sha512') }}"
        groups: sudo
        shell: /bin/bash
        append: yes

    - name: Copy SSH key to the new user
      authorized_key:
        user: "{{ new_user_name }}"
        state: present
        key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

    - name: Harden SSH configuration
      block:
        - name: Set custom SSH port
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?Port "
            line: "Port {{ new_ssh_port }}"

        - name: Disable root login
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?PermitRootLogin"
            line: "PermitRootLogin no"

        - name: Disable password authentication
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?PasswordAuthentication"
            line: "PasswordAuthentication no"

        - name: Enable SSH key authentication
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?PubkeyAuthentication"
            line: "PubkeyAuthentication yes"

        - name: Disable empty passwords
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?PermitEmptyPasswords"
            line: "PermitEmptyPasswords no"

        - name: Disable X11 forwarding
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?X11Forwarding"
            line: "X11Forwarding no"

    - name: Disable password auth in cloud-init (if exists)
      stat:
        path: /etc/ssh/sshd_config.d/50-cloud-init.conf
      register: sshd_config_file

    - name: Disable password auth in 50-cloud-init.conf
      lineinfile:
        path: /etc/ssh/sshd_config.d/50-cloud-init.conf
        regexp: "^#*PasswordAuthentication"
        line: "PasswordAuthentication no"
      when: sshd_config_file.stat.exists

    - name: Disable UFW and install iptables
      block:
        - name: Disable UFW
          command: ufw disable
          ignore_errors: true

        - name: Install iptables packages
          apt:
            name:
              - iptables
              - netfilter-persistent
              - iptables-persistent
            state: present
          register: apt_result
          until: apt_result is succeeded
          retries: 10
          delay: 15

        - name: Enable netfilter-persistent
          systemd:
            name: netfilter-persistent
            enabled: yes
            state: started

    - name: Deploy iptables rules
      template:
        src: iptables.rules.j2
        dest: /etc/iptables/rules.v4
        mode: "0644"

    - name: Apply sysctl configurations
      block:
        - name: Write custom sysctl configuration
          copy:
            dest: /etc/sysctl.d/99-custom.conf
            content: |
              net.core.default_qdisc=fq
              net.ipv4.tcp_congestion_control=bbr
              net.ipv4.tcp_syncookies=1
              net.ipv4.tcp_fastopen=3
              net.ipv4.icmp_echo_ignore_broadcasts=1
              net.ipv6.conf.all.disable_ipv6=1
        - name: Apply sysctl changes
          command: sysctl --system

    - name: Reboot
      reboot:
        reboot_timeout: 3
