- name: "ansiblecfgs: generate self-signed certificate"
  hosts: all
  become: true
  tasks:
    - name: Ensure ssl group exists
      group:
        name: "{{ ssl_group_name }}"
        state: present

    - name: Ensure certificate directories exist
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: "{{ ssl_group_name }}"
        mode: "0750"
      loop:
        - "{{ cert_key_path | dirname }}"
        - "{{ cert_pubkey_path | dirname }}"

    - name: Generate self-signed certificate
      ansible.builtin.command: >
        openssl req -x509 -newkey rsa:2048
        -keyout {{ cert_key_path }}
        -out {{ cert_pubkey_path }}
        -days {{ cert_days }}
        -nodes
        -subj "/CN={{ sni }}"
        -addext "subjectAltName=DNS:{{ sni }},DNS:www.{{ sni }}"
      args:
        creates: "{{ cert_pubkey_path }}"

    - name: Ensure private key has correct permissions
      file:
        path: "{{ cert_key_path }}"
        owner: root
        group: "{{ ssl_group_name }}"
        mode: "0640"

    - name: Ensure certificate has correct permissions
      file:
        path: "{{ cert_pubkey_path }}"
        owner: root
        group: "{{ ssl_group_name }}"
        mode: "0644"

    - name: Read certificate content
      ansible.builtin.slurp:
        src: "{{ cert_pubkey_path }}"
      register: cert_pubkey_content

    - name: Read private key content
      ansible.builtin.slurp:
        src: "{{ cert_key_path }}"
      register: cert_key_content

    - name: Convert certificate to JSON array
      become: false
      ansible.builtin.set_fact:
        certificate_json: >-
          {{ (cert_pubkey_content.content | b64decode).splitlines() | reject('equalto','') | list }}

    - name: Convert private key to JSON array
      become: false
      ansible.builtin.set_fact:
        certificate_key_json: >-
          {{ (cert_key_content.content | b64decode).splitlines() | reject('equalto','') | list }}

    - name: Save certificate JSON on localhost
      become: false
      ansible.builtin.copy:
        dest: "./{{ inventory_hostname }}-cert.json"
        content: |
          {
            "certificate": {{ certificate_json | to_nice_json }}
          }
        mode: "0644"
      delegate_to: localhost
      run_once: true

    - name: Save private key JSON on localhost
      become: false
      ansible.builtin.copy:
        dest: "./{{ inventory_hostname }}-cert-key.json"
        content: |
          {
            "private_key": {{ certificate_key_json | to_nice_json }}
          }
        mode: "0600"
      delegate_to: localhost
      run_once: true
